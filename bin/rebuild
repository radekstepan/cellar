#!/usr/bin/env bash
# Rebuild and start the Docker container

# Go to the root of the project
cd "$(dirname "$0")/.."

output=$(docker-compose up -d --build --remove-orphans 2>&1)
if [ $? -ne 0 ]; then
  echo "Failed to rebuild and start."
  echo ""
  echo "Details:"
  echo "$output"
  echo ""
  echo "Suggestion: Check Docker daemon is running and review the build errors above."
  exit 1
fi

for i in {1..7}; do
  if curl -s http://localhost:3001/api/schema >/dev/null; then
    echo "Rebuilt and started."
    exit 0
  fi
  sleep 1
done

echo "Failed to start after rebuild."
echo ""
echo "Details: The server did not respond at http://localhost:3001 within 7 seconds."
echo ""
echo "Suggestion: Check if port 3001 is already in use, or view 'docker-compose logs'."
exit 1
